// ============================================
// SCRIPT 1: GameManager.cs
// ============================================
using UnityEngine;
using UnityEngine.UI;

public class GameManager : MonoBehaviour
{
    void Awake()
    {
        gameObject.AddComponent<ContadorCalabazas>();
        gameObject.AddComponent<UIManager>();
    }
}

// CONTADOR DE CALABAZAS
public class ContadorCalabazas : MonoBehaviour
{
    public static ContadorCalabazas Instance;

    private int calabazasEnMano = 0; // Calabazas que lleva (invisibles, no contadas aún)
    private int calabazasQuemadas = 0; // Calabazas que ya sumaron al contador
    private int total = 5;

    void Awake()
    {
        Instance = this;
    }

    // Coger calabaza (NO suma, solo la guarda en mano)
    public void CogerCalabaza()
    {
        calabazasEnMano++;
        Debug.Log($"Calabazas en mano: {calabazasEnMano} (aún no cuentan)");
    }

    // Quemar calabazas (AQUÍ se suman al contador)
    public void QuemarCalabazas()
    {
        if (calabazasEnMano > 0)
        {
            calabazasQuemadas += calabazasEnMano; // Suma todas las que llevas
            Debug.Log($"¡Quemadas {calabazasEnMano} calabazas!");
            calabazasEnMano = 0; // Ya no llevas ninguna
            UIManager.Instance.ActualizarContador(calabazasQuemadas, total);
        }
    }

    // ¿Tiene calabazas en mano?
    public bool TieneCalabazas()
    {
        return calabazasEnMano > 0;
    }
}

// INTERFAZ GRÁFICA
public class UIManager : MonoBehaviour
{
    public static UIManager Instance;

    private Text textoE;
    private Text textoContador;

    void Awake()
    {
        Instance = this;
    }

    void Start()
    {
        CrearUI();
    }

    void CrearUI()
    {
        // CANVAS
        GameObject canvas = new GameObject("Canvas");
        Canvas c = canvas.AddComponent<Canvas>();
        c.renderMode = RenderMode.ScreenSpaceOverlay;
        canvas.AddComponent<CanvasScaler>();
        canvas.AddComponent<GraphicRaycaster>();

        // TEXTO E (centro)
        GameObject objE = new GameObject("TextoE");
        objE.transform.SetParent(canvas.transform, false);
        textoE = objE.AddComponent<Text>();
        textoE.text = "[ E ]";
        textoE.font = Resources.GetBuiltinResource<Font>("LegacyRuntime.ttf");
        textoE.fontSize = 50;
        textoE.alignment = TextAnchor.MiddleCenter;
        textoE.color = Color.white;

        RectTransform rtE = objE.GetComponent<RectTransform>();
        rtE.anchorMin = new Vector2(0.5f, 0.5f);
        rtE.anchorMax = new Vector2(0.5f, 0.5f);
        rtE.anchoredPosition = new Vector2(0, -100);
        rtE.sizeDelta = new Vector2(200, 80);

        // CONTADOR (arriba centrado)
        GameObject objContador = new GameObject("TextoContador");
        objContador.transform.SetParent(canvas.transform, false);
        textoContador = objContador.AddComponent<Text>();
        textoContador.text = "Calabazas: 0/5";
        textoContador.font = Resources.GetBuiltinResource<Font>("LegacyRuntime.ttf");
        textoContador.fontSize = 30;
        textoContador.alignment = TextAnchor.UpperCenter;
        textoContador.color = Color.green;

        RectTransform rtC = objContador.GetComponent<RectTransform>();
        rtC.anchorMin = new Vector2(0.5f, 1);
        rtC.anchorMax = new Vector2(0.5f, 1);
        rtC.anchoredPosition = new Vector2(0, -20);
        rtC.sizeDelta = new Vector2(300, 50);

        MostrarE(false);
    }

    public void MostrarE(bool mostrar)
    {
        if (textoE != null)
            textoE.gameObject.SetActive(mostrar);
    }

    public void ActualizarContador(int actual, int total)
    {
        if (textoContador != null)
            textoContador.text = $"Calabazas: {actual}/{total}";
    }
}


// ============================================
// SCRIPT 2: Calabaza.cs
// ============================================
using UnityEngine;

public class Calabaza : MonoBehaviour
{
    [SerializeField] private float distancia = 3f;

    private Transform jugador;
    private bool cerca = false;

    void Start()
    {
        jugador = GameObject.FindGameObjectWithTag("Player").transform;
    }

    void Update()
    {
        float dist = Vector3.Distance(transform.position, jugador.position);

        // ¿Está cerca?
        if (dist <= distancia)
        {
            if (!cerca)
            {
                cerca = true;
                UIManager.Instance.MostrarE(true);
            }

            // ¿Presionó E?
            if (Input.GetKeyDown(KeyCode.E))
            {
                Recoger();
            }
        }
        else
        {
            if (cerca)
            {
                cerca = false;
                UIManager.Instance.MostrarE(false);
            }
        }
    }

    void Recoger()
    {
        UIManager.Instance.MostrarE(false);
        ContadorCalabazas.Instance.CogerCalabaza(); // Solo la coge, NO suma
        gameObject.SetActive(false); // Se hace invisible
    }
}


// ============================================
// SCRIPT 3: Quemar.cs
// ============================================
using UnityEngine;

public class Quemar : MonoBehaviour
{
    [SerializeField] private float distancia = 3f;

    private Transform jugador;
    private bool cerca = false;

    void Start()
    {
        jugador = GameObject.FindGameObjectWithTag("Player").transform;
    }

    void Update()
    {
        float dist = Vector3.Distance(transform.position, jugador.position);

        // ¿Está cerca?
        if (dist <= distancia)
        {
            if (!cerca)
            {
                cerca = true;
                UIManager.Instance.MostrarE(true);
            }

            // ¿Presionó E?
            if (Input.GetKeyDown(KeyCode.E))
            {
                IntentarQuemar();
            }
        }
        else
        {
            if (cerca)
            {
                cerca = false;
                UIManager.Instance.MostrarE(false);
            }
        }
    }

    void IntentarQuemar()
    {
        // Solo quema si tiene calabazas en mano
        if (ContadorCalabazas.Instance.TieneCalabazas())
        {
            UIManager.Instance.MostrarE(false);
            ContadorCalabazas.Instance.QuemarCalabazas(); // AQUÍ se suma al contador
            // REMOVIDO: gameObject.SetActive(false);
            Debug.Log("¡Calabazas quemadas y sumadas!");
        }
        else
        {
            Debug.Log("No tienes calabazas para quemar");
        }
    }
}
