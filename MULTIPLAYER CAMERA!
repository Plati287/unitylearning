using System.Collections;
using System.Collections.Generic;
using UnityEngine;
using Photon.Pun;

public class PlayerController : MonoBehaviourPunCallbacks
{
    [Header("Movement Settings")]
    public float moveSpeed = 5f;
    public float gravity = -9.81f;

    [Header("Camera Settings")]
    public Vector2 sensibility = new Vector2(2f, 2f);
    public float minVerticalAngle = -80f;
    public float maxVerticalAngle = 80f;

    private Camera playerCamera;
    private CharacterController characterController;
    private float verticalRotation = 0f;
    private Vector3 velocity;

    void Start()
    {
        // Configurar el CharacterController
        characterController = GetComponent<CharacterController>();
        if (characterController == null)
        {
            characterController = gameObject.AddComponent<CharacterController>();
            characterController.center = new Vector3(0, 1, 0);
            characterController.radius = 0.5f;
            characterController.height = 2f;
        }

        // Configurar la cámara solo para el jugador local
        ConfigureCamera();

        // Solo bloquear el cursor si es nuestro jugador
        if (photonView.IsMine)
        {
            Cursor.lockState = CursorLockMode.Locked;
            Cursor.visible = false;
        }
    }

    void ConfigureCamera()
    {
        // Buscar la cámara hija
        Transform cameraTransform = transform.Find("Camera");

        if (cameraTransform != null)
        {
            playerCamera = cameraTransform.GetComponent<Camera>();

            if (playerCamera == null)
            {
                playerCamera = cameraTransform.gameObject.AddComponent<Camera>();
            }
        }
        else
        {
            // Si no existe, crear la cámara
            GameObject cameraObj = new GameObject("Camera");
            cameraObj.transform.SetParent(transform);
            cameraObj.transform.localPosition = new Vector3(0, 1.6f, 0);
            cameraObj.transform.localRotation = Quaternion.identity;
            playerCamera = cameraObj.AddComponent<Camera>();
        }

        // Configurar AudioListener
        AudioListener audioListener = playerCamera.GetComponent<AudioListener>();

        if (photonView.IsMine)
        {
            // Activar cámara y audio para el jugador local
            playerCamera.enabled = true;
            playerCamera.tag = "MainCamera";

            if (audioListener == null)
            {
                audioListener = playerCamera.gameObject.AddComponent<AudioListener>();
            }
            audioListener.enabled = true;
        }
        else
        {
            // Desactivar cámara y audio para jugadores remotos
            playerCamera.enabled = false;

            if (audioListener != null)
            {
                audioListener.enabled = false;
            }
        }
    }

    void Update()
    {
        // Solo procesar input para el jugador local
        if (!photonView.IsMine)
        {
            return;
        }

        HandleMovement();
        HandleMouseLook();

        // Desbloquear cursor con ESC
        if (Input.GetKeyDown(KeyCode.Escape))
        {
            ToggleCursorLock();
        }
    }

    void HandleMovement()
    {
        // Obtener input
        float horizontal = 0f;
        float vertical = 0f;

        if (Input.GetKey(KeyCode.W)) vertical += 1f;
        if (Input.GetKey(KeyCode.S)) vertical -= 1f;
        if (Input.GetKey(KeyCode.D)) horizontal += 1f;
        if (Input.GetKey(KeyCode.A)) horizontal -= 1f;

        // Calcular dirección de movimiento
        Vector3 moveDirection = (transform.right * horizontal + transform.forward * vertical).normalized;

        // Aplicar velocidad de movimiento
        Vector3 move = moveDirection * moveSpeed * Time.deltaTime;

        // Aplicar gravedad
        if (characterController.isGrounded && velocity.y < 0)
        {
            velocity.y = -2f; // Pequeña fuerza para mantener en el suelo
        }

        velocity.y += gravity * Time.deltaTime;
        move.y = velocity.y * Time.deltaTime;

        // Mover el personaje
        characterController.Move(move);
    }

    void HandleMouseLook()
    {
        // Solo rotar si el cursor está bloqueado
        if (Cursor.lockState != CursorLockMode.Locked)
        {
            return;
        }

        // Obtener input del mouse
        float mouseX = Input.GetAxis("Mouse X") * sensibility.x;
        float mouseY = Input.GetAxis("Mouse Y") * sensibility.y;

        // Rotación horizontal (jugador completo)
        transform.Rotate(Vector3.up * mouseX);

        // Rotación vertical (solo la cámara)
        verticalRotation -= mouseY;
        verticalRotation = Mathf.Clamp(verticalRotation, minVerticalAngle, maxVerticalAngle);

        if (playerCamera != null)
        {
            playerCamera.transform.localEulerAngles = new Vector3(verticalRotation, 0f, 0f);
        }
    }

    void ToggleCursorLock()
    {
        if (Cursor.lockState == CursorLockMode.Locked)
        {
            Cursor.lockState = CursorLockMode.None;
            Cursor.visible = true;
        }
        else
        {
            Cursor.lockState = CursorLockMode.Locked;
            Cursor.visible = false;
        }
    }

    // Método público para desactivar el control (útil para menús, etc.)
    public void SetControlEnabled(bool enabled)
    {
        this.enabled = enabled;

        if (!enabled)
        {
            Cursor.lockState = CursorLockMode.None;
            Cursor.visible = true;
        }
    }
}
