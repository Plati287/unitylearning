using System.Collections;
using System.Collections.Generic;
using UnityEngine;
using Photon.Pun;

public class PlayerController : MonoBehaviourPunCallbacks
{
    [Header("Movement Settings")]
    public float moveSpeed = 5f;
    public float gravity = -9.81f;

    [Header("Camera Settings")]
    public float cameraHeight = 3.5f;
    public Vector2 sensibility = new Vector2(2f, 2f);
    public float minVerticalAngle = -80f;
    public float maxVerticalAngle = 80f;

    private Camera playerCamera;
    private CharacterController characterController;
    private float verticalRotation = 0f;
    private Vector3 velocity;
    private bool cursorShouldBeLocked = true; // Estado deseado del cursor

    void Start()
    {
        characterController = GetComponent<CharacterController>();
        if (characterController == null)
        {
            characterController = gameObject.AddComponent<CharacterController>();
            characterController.center = new Vector3(0, 1, 0);
            characterController.radius = 0.5f;
            characterController.height = 2f;
        }

        ConfigureCamera();

        if (photonView.IsMine)
        {
            LockCursor();  // Asegura que el cursor esté bloqueado al principio
        }
    }

    void ConfigureCamera()
    {
        Transform cameraTransform = transform.Find("Camera");

        if (cameraTransform != null)
        {
            playerCamera = cameraTransform.GetComponent<Camera>();

            if (playerCamera == null)
            {
                playerCamera = cameraTransform.gameObject.AddComponent<Camera>();
            }
        }
        else
        {
            GameObject cameraObj = new GameObject("Camera");
            cameraObj.transform.SetParent(transform);
            cameraObj.transform.localPosition = new Vector3(0, cameraHeight, 0);
            cameraObj.transform.localRotation = Quaternion.identity;
            playerCamera = cameraObj.AddComponent<Camera>();
        }

        AudioListener audioListener = playerCamera.GetComponent<AudioListener>();

        if (photonView.IsMine)
        {
            playerCamera.enabled = true;
            playerCamera.tag = "MainCamera";

            if (audioListener == null)
            {
                audioListener = playerCamera.gameObject.AddComponent<AudioListener>();
            }
            audioListener.enabled = true;
        }
        else
        {
            playerCamera.enabled = false;

            if (audioListener != null)
            {
                audioListener.enabled = false;
            }
        }
    }

    void Update()
    {
        if (!photonView.IsMine)
        {
            return;
        }

        // Forzar el bloqueo del cursor si se desbloquea accidentalmente
        if (cursorShouldBeLocked && Cursor.lockState != CursorLockMode.Locked)
        {
            LockCursor();
        }

        HandleMovement();
        HandleMouseLook();

        // Toggle con ESC
        if (Input.GetKeyDown(KeyCode.Escape))
        {
            ToggleCursorLock();
        }

        // Detectar si el ratón toca la pantalla después de desbloquearlo con Escape
        if (Cursor.lockState != CursorLockMode.Locked && Input.mousePosition.x >= 0 && Input.mousePosition.x <= Screen.width && Input.mousePosition.y >= 0 && Input.mousePosition.y <= Screen.height)
        {
            LockCursor(); // Bloquear el cursor al tocar la pantalla
        }
    }

    void HandleMovement()
    {
        float horizontal = 0f;
        float vertical = 0f;

        if (Input.GetKey(KeyCode.W)) vertical += 1f;
        if (Input.GetKey(KeyCode.S)) vertical -= 1f;
        if (Input.GetKey(KeyCode.D)) horizontal += 1f;
        if (Input.GetKey(KeyCode.A)) horizontal -= 1f;

        Vector3 moveDirection = (transform.right * horizontal + transform.forward * vertical).normalized;
        Vector3 move = moveDirection * moveSpeed * Time.deltaTime;

        if (characterController.isGrounded && velocity.y < 0)
        {
            velocity.y = -2f;
        }

        velocity.y += gravity * Time.deltaTime;
        move.y = velocity.y * Time.deltaTime;

        characterController.Move(move);
    }

    void HandleMouseLook()
    {
        // Solo rotar si el cursor está bloqueado
        if (Cursor.lockState != CursorLockMode.Locked)
        {
            return;
        }

        float mouseX = Input.GetAxis("Mouse X") * sensibility.x;
        float mouseY = Input.GetAxis("Mouse Y") * sensibility.y;

        transform.Rotate(Vector3.up * mouseX);

        verticalRotation -= mouseY;
        verticalRotation = Mathf.Clamp(verticalRotation, minVerticalAngle, maxVerticalAngle);

        if (playerCamera != null)
        {
            playerCamera.transform.localEulerAngles = new Vector3(verticalRotation, 0f, 0f);
        }
    }

    void LockCursor()
    {
        cursorShouldBeLocked = true;
        Cursor.lockState = CursorLockMode.Locked;
        Cursor.visible = false;
    }

    void UnlockCursor()
    {
        cursorShouldBeLocked = false;
        Cursor.lockState = CursorLockMode.None;
        Cursor.visible = true;
    }

    void ToggleCursorLock()
    {
        if (cursorShouldBeLocked)
        {
            UnlockCursor();
        }
        else
        {
            LockCursor();
        }
    }

    // Método público para desactivar el control
    public void SetControlEnabled(bool enabled)
    {
        this.enabled = enabled;

        if (!enabled)
        {
            UnlockCursor();
        }
        else
        {
            LockCursor();
        }
    }

    // Asegurar que el cursor se bloquee al volver a la ventana
    void OnApplicationFocus(bool hasFocus)
    {
        if (hasFocus && photonView.IsMine && cursorShouldBeLocked)
        {
            LockCursor();
        }
    }
}

